


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > ProductFlow</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.increff.project.useCase</a>
</div>

<h1>Coverage Summary for Class: ProductFlow (com.increff.project.useCase)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ProductFlow</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    75%
  </span>
  <span class="absValue">
    (6/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    11.1%
  </span>
  <span class="absValue">
    (2/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    22%
  </span>
  <span class="absValue">
    (13/59)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.increff.project.useCase;
&nbsp;
&nbsp;import com.increff.project.api.ClientAPI;
&nbsp;import com.increff.project.api.ProductAPI;
&nbsp;import com.increff.project.entity.ClientPojo;
&nbsp;import com.increff.project.exception.ApiException;
&nbsp;import com.increff.project.entity.ProductPojo;
&nbsp;import com.increff.project.utils.helpers.TsvParserHelper;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.data.domain.Page;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;
&nbsp;import java.util.*;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;@Transactional
&nbsp;@Service
<b class="fc">&nbsp;public class ProductFlow {</b>
&nbsp;
&nbsp;    @Autowired
&nbsp;    private ProductAPI productAPI;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private ClientAPI clientAPI;
&nbsp;
&nbsp;    /* Add a single Product */
&nbsp;    @Transactional(rollbackFor = Exception.class)
&nbsp;    public void addProduct(ProductPojo product,String clientName) {
&nbsp;
<b class="fc">&nbsp;        ClientPojo client = clientAPI.findClientByName(clientName);</b>
<b class="fc">&nbsp;        product.setClientId(client.getId());</b>
<b class="fc">&nbsp;        productAPI.addProduct(product);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional(rollbackFor = Exception.class)
&nbsp;    public void updateProduct(ProductPojo product,String clientName)
&nbsp;    {
<b class="fc">&nbsp;        ClientPojo client = clientAPI.findClientByName(clientName);</b>
<b class="fc">&nbsp;        if (Objects.isNull(client)) {</b>
<b class="fc">&nbsp;            throw new ApiException(&quot;Invalid clientId: &quot; + product.getClientId());</b>
&nbsp;        }
<b class="fc">&nbsp;        product.setClientId(client.getId());</b>
<b class="fc">&nbsp;        productAPI.updateProduct(product);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional(readOnly = true)
&nbsp;    public Page&lt;ProductPojo&gt; getAllClientProducts(String clientName,int page,int size)
&nbsp;    {
<b class="fc">&nbsp;        int clientId = (clientAPI.findClientByName(clientName)).getId();</b>
<b class="fc">&nbsp;        return  productAPI.getAllClientProducts(clientId,page,size);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional(readOnly = true)
<b class="fc">&nbsp;    public ProductPojo findByBarcode(String barcode){return productAPI.getByBarcode(barcode);}</b>
&nbsp;
&nbsp;    @Transactional(readOnly = true)
&nbsp;    public Page&lt;ProductPojo&gt; getAllOrders(int pageNumber, int pageSize){
<b class="fc">&nbsp;        return productAPI.getAllOrders(pageNumber,pageSize);</b>
&nbsp;    }
&nbsp;
&nbsp;    public List&lt;ClientPojo&gt; selectExistingClientIds(Page&lt;ProductPojo&gt; productPojoPage)
&nbsp;    {
<b class="nc">&nbsp;        List&lt;Integer&gt; clientIds = productPojoPage.getContent()</b>
<b class="nc">&nbsp;                                  .stream()</b>
<b class="nc">&nbsp;                                  .map(ProductPojo::getClientId)</b>
<b class="nc">&nbsp;                                  .toList();</b>
&nbsp;
<b class="nc">&nbsp;        return clientAPI.selectExistingClientWithIds(clientIds);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional(rollbackFor = Exception.class)
&nbsp;    public Map&lt;String,String&gt; addMultipleProducts(String base64Tsv)
&nbsp;    {
<b class="nc">&nbsp;        List&lt;String[]&gt; rows = TsvParserHelper.parseBase64Tsv(base64Tsv);</b>
<b class="nc">&nbsp;        Map&lt;String, String&gt; results = new LinkedHashMap&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        if (rows.isEmpty()) {throw new ApiException(&quot;TSV file is empty&quot;);}</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;ProductPojo&gt; products = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        Set&lt;String&gt; clientNames = new HashSet&lt;&gt;();</b>
<b class="nc">&nbsp;        Set&lt;String&gt; barcodes = new HashSet&lt;&gt;();</b>
<b class="nc">&nbsp;        Map&lt;String,String&gt; productBarcodeToClientNameMapper = new LinkedHashMap&lt;&gt;();</b>
&nbsp;
&nbsp;        /* 2. Convert rows â†’ entities */
<b class="nc">&nbsp;        for (String[] row : rows)</b>
&nbsp;        {
&nbsp;
<b class="nc">&nbsp;            if (row.length != 4 &amp;&amp; row.length != 5) {</b>
<b class="nc">&nbsp;                throw new ApiException(&quot;Invalid TSV format. Expected 4 or 5 columns.&quot;);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            String barcode = row[0].trim();</b>
<b class="nc">&nbsp;            String name    = row[1].trim();</b>
<b class="nc">&nbsp;            double mrp     = Double.parseDouble(row[2].trim());</b>
<b class="nc">&nbsp;            String clientName   = (row[3].trim()).toLowerCase(Locale.ROOT);</b>
<b class="nc">&nbsp;            String imageUrl = row.length &gt; 4 ? row[4].trim() : null;</b>
&nbsp;
<b class="nc">&nbsp;            ProductPojo product = new ProductPojo();</b>
<b class="nc">&nbsp;            product.setBarcode(barcode);</b>
<b class="nc">&nbsp;            product.setName(name);</b>
<b class="nc">&nbsp;            product.setMrp(mrp);</b>
<b class="nc">&nbsp;            product.setImageUrl(imageUrl);</b>
<b class="nc">&nbsp;            productBarcodeToClientNameMapper.put(barcode,clientName);</b>
&nbsp;
<b class="nc">&nbsp;            products.add(product);</b>
<b class="nc">&nbsp;            clientNames.add(clientName);</b>
<b class="nc">&nbsp;            barcodes.add(barcode);</b>
&nbsp;        }
&nbsp;
&nbsp;        /* 3. Validate clientIds (ONE DB call) */
<b class="nc">&nbsp;        List&lt;String&gt; existingClientNames = clientAPI.selectExistingClientNames(clientNames);</b>
<b class="nc">&nbsp;        Set&lt;String&gt; existingClientSet = new HashSet&lt;&gt;(existingClientNames);</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;Object[]&gt; ProductIdBarcodes = productAPI.selectExistingBarcodes(new ArrayList&lt;&gt;(barcodes));</b>
&nbsp;
<b class="nc">&nbsp;        Set&lt;String&gt; existingBarcodeSet = ProductIdBarcodes.stream()</b>
<b class="nc">&nbsp;                .map(row -&gt; (String) row[0])</b>
<b class="nc">&nbsp;                .collect(Collectors.toSet());</b>
&nbsp;
&nbsp;        /* 5. Persist products */
<b class="nc">&nbsp;        for (ProductPojo product : products)</b>
&nbsp;        {
<b class="nc">&nbsp;            String clientNameFetched = productBarcodeToClientNameMapper.get(product.getBarcode());</b>
<b class="nc">&nbsp;            if(!existingClientSet.contains(clientNameFetched))</b>
&nbsp;            {
<b class="nc">&nbsp;                String res = &quot;Client does not exist with name &quot; + clientNameFetched;</b>
<b class="nc">&nbsp;                results.put(product.getBarcode(), res);</b>
&nbsp;                continue;
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (existingBarcodeSet.contains(product.getBarcode()))</b>
&nbsp;            {
<b class="nc">&nbsp;                results.put(product.getBarcode(), &quot;Duplicate barcode&quot;);</b>
&nbsp;                continue;
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            product.setClientId(clientAPI.findClientByName(clientNameFetched).getId());</b>
<b class="nc">&nbsp;            productAPI.addProduct(product);</b>
<b class="nc">&nbsp;            results.put(product.getBarcode(), &quot;SUCCESS&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        return results;</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-10 13:23</div>
</div>
</body>
</html>
